{% extends "base/base.html" %}
{% block title %}Paso 5 | Permisos globales{% endblock %}

{% block content %}
<div class="container-fluid">
  {% include "catalog/wizard/_progress.html" %}

  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <div class="fw-semibold mb-1">
      <i class="bi bi-info-circle"></i> Carga única
    </div>
    <div class="small">Los permisos globales que definas acá se aplican a todas las empresas de esta solicitud.</div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- SECCIÓN: Módulos -->
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="bi bi-boxes"></i> Módulos
        </h5>
      </div>
      <div class="card-body">
        {% for field in scope_form %}
          {% if field.field.widget.input_type != 'hidden' %}
            <div class="mb-3">
              <label class="form-label" for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
              </label>
              {% if field.errors %}
                {{ field }}
                <div class="invalid-feedback d-block">
                  {% for error in field.errors %}
                    <div>{{ error }}</div>
                  {% endfor %}
                </div>
              {% else %}
                {{ field }}
              {% endif %}
              {% if field.help_text %}
                <small class="form-text text-muted d-block mt-1">{{ field.help_text|safe }}</small>
              {% endif %}
            </div>
          {% else %}
            {{ field }}
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- SECCIÓN: Acciones -->
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="bi bi-lightning"></i> Acciones
        </h5>
      </div>
      <div class="card-body">
        {{ actions_fs.management_form }}
        {% if actions_fs.non_form_errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong>
            {% for error in actions_fs.non_form_errors %}
              <div>{{ error }}</div>
            {% endfor %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 40%;">Acción</th>
                <th>Valor</th>
                <th style="width: 80px;">Activo</th>
              </tr>
            </thead>
            <tbody>
              {% for f in actions_fs %}
              <tr>
                <td>
                  <strong>{{ f.instance.action_permission.group }}</strong>
                  <br>
                  <span class="text-muted small">{{ f.instance.action_permission.action }}</span>
                </td>
                <td>
                  <div class="d-flex gap-2">
                    {{ f.value_bool }}
                    {{ f.value_int }}
                    {{ f.value_decimal }}
                    {{ f.value_text }}
                  </div>
                  {% if f.non_field_errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in f.non_field_errors %}
                        <div>{{ error }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.is_active }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SECCIÓN: Matriz de Permisos -->
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="bi bi-table"></i> Matriz de Permisos
        </h5>
      </div>
      <div class="card-body">
        {{ matrix_fs.management_form }}
        {% if matrix_fs.non_form_errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong>
            {% for error in matrix_fs.non_form_errors %}
              <div>{{ error }}</div>
            {% endfor %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 40%;">Permiso</th>
                <th class="text-center" style="width: 60px;">
                  <span title="Crear">C</span>
                </th>
                <th class="text-center" style="width: 60px;">
                  <span title="Actualizar">U</span>
                </th>
                <th class="text-center" style="width: 60px;">
                  <span title="Autorizar">A</span>
                </th>
                <th class="text-center" style="width: 60px;">
                  <span title="Cerrar">CL</span>
                </th>
                <th class="text-center" style="width: 60px;">
                  <span title="Cancelar">CA</span>
                </th>
                <th class="text-center" style="width: 60px;">
                  <span title="Validez">V</span>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for f in matrix_fs %}
              <tr>
                <td><strong>{{ f.instance.permission.name }}</strong></td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.can_create }}
                  </div>
                </td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.can_update }}
                  </div>
                </td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.can_authorize }}
                  </div>
                </td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.can_close }}
                  </div>
                </td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.can_cancel }}
                  </div>
                </td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.can_update_validity }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SECCIÓN: Medios de Pago -->
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="bi bi-credit-card"></i> Medios de Pago
        </h5>
      </div>
      <div class="card-body">
        {{ payments_fs.management_form }}
        {% if payments_fs.non_form_errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error:</strong>
            {% for error in payments_fs.non_form_errors %}
              <div>{{ error }}</div>
            {% endfor %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 60%;">Medio de Pago</th>
                <th style="width: 100px;" class="text-center">Habilitado</th>
                <th style="width: 80px;" class="text-center">Activo</th>
              </tr>
            </thead>
            <tbody>
              {% for f in payments_fs %}
              <tr>
                <td><strong>{{ f.instance.payment_method.name }}</strong></td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.enabled }}
                  </div>
                </td>
                <td class="text-center">
                  <div class="form-check form-check-inline mb-0">
                    {{ f.is_active }}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="mt-4 d-flex gap-2 sticky-bottom bg-white p-3 border-top">
      <button type="submit" class="btn btn-success">
        <i class="bi bi-check-circle"></i> Guardar y finalizar
      </button>
      <a href="{% url 'catalog:w_step_4' request_obj.id %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver
      </a>
    </div>
  </form>
</div>
{% endblock %}
